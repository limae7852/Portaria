<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ROSSETTI - Controle de Portaria</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    #modal { z-index: 60; }
    .filter-active { box-shadow: 0 0 0 3px rgba(59,130,246,0.25); }
    th.sortable:hover { cursor: pointer; background-color: #f1f5f9; }
  </style>
</head>
<body class="bg-gray-50">
  <nav class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">ROSSETTI</h1>
  </nav>

  <main class="p-8 max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-3xl font-bold text-gray-800">Controle de Portaria</h1>
      <button id="novoRegistroBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
        <i data-feather="plus" class="mr-2"></i> Novo Registro
      </button>
    </div>

    <!-- Filtros -->
    <div class="flex flex-wrap items-center space-x-3 mb-4">
      <span class="text-gray-700 font-semibold">Filtrar:</span>
      <button id="filtroTodos" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">Todos</button>
      <button id="filtroPresentes" class="bg-green-200 hover:bg-green-300 px-3 py-1 rounded">Presentes</button>
      <button id="filtroSaida" class="bg-red-200 hover:bg-red-300 px-3 py-1 rounded">Saíram</button>

      <div class="relative ml-auto w-full sm:w-64 mt-3 sm:mt-0">
        <input id="buscaInput" type="text" placeholder="Buscar..." class="pl-10 pr-4 py-2 w-full border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <i data-feather="search" class="absolute left-3 top-2.5 text-gray-400"></i>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
      <div class="p-6 overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="tabelaRegistros">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="visitante">Visitante</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="documento">Documento</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="placa">Placa</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="destino">Destino</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="motivo">Motivo</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="entrada">Entrada</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase sortable" data-sort="saida">Saída</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
            </tr>
          </thead>
          <tbody id="listaRegistros" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-xl w-96">
      <h2 class="text-xl font-semibold mb-4">Novo Registro</h2>
      <input id="visitante" type="text" placeholder="Nome do visitante" class="w-full border p-2 rounded mb-3">
      <input id="documento" type="text" placeholder="Documento (CPF/RG)" class="w-full border p-2 rounded mb-3">
      <input id="placa" type="text" placeholder="Placa do veículo (ex: ABC1D23)" class="w-full border p-2 rounded mb-3">
      <input id="destino" type="text" placeholder="Destino (Ex: Apto 101)" class="w-full border p-2 rounded mb-3">
      <input id="motivo" type="text" placeholder="Motivo da vinda" class="w-full border p-2 rounded mb-3">
      <div class="flex justify-end space-x-3">
        <button id="cancelar" class="bg-gray-300 px-4 py-2 rounded">Cancelar</button>
        <button id="salvar" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button>
      </div>
    </div>
  </div>

  <footer class="text-center py-4 text-gray-500">© 2025 GateGuard</footer>

  <script type="module">
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js');
        const {
          getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, serverTimestamp
        } = await import('https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js');

        const firebaseConfig = {
          apiKey: "AIzaSyCmZBxRVcmTPJFLdWWcNd07LZPJYZnR5N0",
          authDomain: "portaria-e22ae.firebaseapp.com",
          projectId: "portaria-e22ae",
          storageBucket: "portaria-e22ae.firebasestorage.app",
          messagingSenderId: "663485115589",
          appId: "1:663485115589:web:4b2f860ede7f0f7b5854ac",
          measurementId: "G-QEGQN6CTBB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const tabela = document.getElementById("listaRegistros");
        const modal = document.getElementById("modal");
        const btnNovo = document.getElementById("novoRegistroBtn");
        const btnSalvar = document.getElementById("salvar");
        const btnCancelar = document.getElementById("cancelar");

        const filtroTodos = document.getElementById("filtroTodos");
        const filtroPresentes = document.getElementById("filtroPresentes");
        const filtroSaida = document.getElementById("filtroSaida");
        const buscaInput = document.getElementById("buscaInput");
        const cabecalhos = document.querySelectorAll("th.sortable");

        let filtroAtual = "todos";
        let termoBusca = "";
        let docsCache = [];
        let sortCampo = "entrada";
        let sortAsc = false;

        feather.replace();

        btnNovo.addEventListener("click", () => {
          modal.classList.remove("hidden");
          document.getElementById('visitante').focus();
        });
        btnCancelar.addEventListener("click", () => modal.classList.add("hidden"));

        btnSalvar.addEventListener("click", async () => {
          const v = val("visitante"), d = val("documento"), p = val("placa"), des = val("destino"), m = val("motivo");
          if (!v || !d || !des || !m) { alert("Preencha visitante, documento, destino e motivo."); return; }
          await addDoc(collection(db, "registros"), {
            visitante: v, documento: d, placa: p || "-", destino: des, motivo: m,
            entrada: new Date().toLocaleString(), saida: "-", timestamp: serverTimestamp()
          });
          ["visitante","documento","placa","destino","motivo"].forEach(id=>document.getElementById(id).value="");
          modal.classList.add("hidden");
        });

        const val = id => document.getElementById(id).value.trim();

        [filtroTodos,filtroPresentes,filtroSaida].forEach(btn=>btn.addEventListener("click",()=>{
          filtroAtual = btn.id.replace("filtro","");
          atualizarVisualFiltro();
          renderizar(docsCache);
        }));

        buscaInput.addEventListener("input",()=>{
          termoBusca = buscaInput.value.toLowerCase();
          renderizar(docsCache);
        });

        cabecalhos.forEach(th=>{
          th.addEventListener("click",()=>{
            const campo=th.dataset.sort;
            if(sortCampo===campo) sortAsc=!sortAsc; else sortAsc=true;
            sortCampo=campo;
            renderizar(docsCache);
          });
        });

        function atualizarVisualFiltro(){
          [filtroTodos,filtroPresentes,filtroSaida].forEach(b=>b.classList.remove("filter-active"));
          if(filtroAtual==="Todos")filtroTodos.classList.add("filter-active");
          if(filtroAtual==="Presentes")filtroPresentes.classList.add("filter-active");
          if(filtroAtual==="Saida")filtroSaida.classList.add("filter-active");
        }
        atualizarVisualFiltro();

        function escapeHtml(str){return str?String(str).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])):"";}

        function renderizar(registros){
          tabela.innerHTML="";
          let filtrados=registros;
          if(filtroAtual==="Presentes") filtrados=filtrados.filter(r=>!r.saida||r.saida==="-");
          if(filtroAtual==="Saida") filtrados=filtrados.filter(r=>r.saida&&r.saida!=="-");
          if(termoBusca){
            filtrados=filtrados.filter(r=>
              [r.visitante,r.documento,r.destino,r.placa,r.motivo]
              .some(campo=>campo&&campo.toLowerCase().includes(termoBusca))
            );
          }

          filtrados.sort((a,b)=>{
            const A=(a[sortCampo]||"").toLowerCase();
            const B=(b[sortCampo]||"").toLowerCase();
            return sortAsc?A.localeCompare(B):B.localeCompare(A);
          });

          if(filtrados.length===0){
            tabela.innerHTML='<tr><td colspan="8" class="text-center py-8 text-gray-500">Nenhum registro encontrado.</td></tr>';
            return;
          }

          filtrados.forEach(dados=>{
            const temSaida=dados.saida&&dados.saida!=="-";
            const tr=document.createElement("tr");
            tr.innerHTML=`
              <td class="px-6 py-4 text-sm">${escapeHtml(dados.visitante)}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.documento)}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.placa||"-")}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.destino)}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.motivo||"-")}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.entrada)}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.saida)}</td>
              <td class="px-6 py-4 text-sm">
                ${!temSaida
                  ? `<button class="text-green-600 hover:text-green-900 mr-3" data-saida="${dados.id}"><i data-feather="log-out"></i></button>
                     <button class="text-red-600 hover:text-red-900" data-del="${dados.id}"><i data-feather="trash-2"></i></button>`
                  : `<span class="text-gray-400 italic">Concluído</span>`}
              </td>`;
            tabela.appendChild(tr);
          });

          feather.replace();

          document.querySelectorAll("[data-saida]").forEach(btn=>{
            btn.addEventListener("click",async()=>{
              const id=btn.dataset.saida;
              if(!confirm("Registrar saída deste visitante?"))return;
              await updateDoc(doc(db,"registros",id),{saida:new Date().toLocaleString()});
            });
          });

          document.querySelectorAll("[data-del]").forEach(btn=>{
            btn.addEventListener("click",async()=>{
              const id=btn.dataset.del;
              if(!confirm("Excluir este registro?"))return;
              await deleteDoc(doc(db,"registros",id));
            });
          });
        }

        onSnapshot(collection(db,"registros"),snap=>{
          docsCache=snap.docs.map(d=>({id:d.id,...d.data()}))
            .sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
          renderizar(docsCache);
        });
      } catch(e){console.error(e);alert("Erro ao iniciar app. Veja console.");}
    });
  </script>

  <script>feather.replace();</script>
</body>
</html>
