<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Controle de Portaria - Firestore</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f8fafc;padding:20px}
    .log{font-family:monospace;white-space:pre-wrap;max-height:200px;overflow:auto;background:#0f172a;color:#e6eef8;padding:8px;border-radius:6px}
  </style>
</head>
<body>
<div class="container">
  <h2 class="mb-3 text-center">üìã Controle de Portaria (Firestore)</h2>

  <form id="formEntrada" class="card p-3 mb-3">
    <div class="row g-2">
      <div class="col-md-4"><input id="nome" class="form-control" placeholder="Nome" required></div>
      <div class="col-md-4"><input id="documento" class="form-control" placeholder="Documento" required></div>
      <div class="col-md-4"><input id="motivo" class="form-control" placeholder="Motivo"></div>
    </div>
    <div class="text-center mt-3">
      <button type="submit" class="btn btn-success">Registrar Entrada</button>
    </div>
  </form>

  <div id="status" class="alert alert-secondary">Status: aguardando...</div>

  <h5>Logs</h5>
  <div id="consoleLog" class="log"></div>
</div>

<!-- üî• SDKs compat (sem modules, sem import/export) -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCmZBxRVcmTPJFLdWWcNd07LZPJYZnR5N0",
    authDomain: "portaria-e22ae.firebaseapp.com",
    projectId: "portaria-e22ae",
    storageBucket: "portaria-e22ae.firebasestorage.app",
    messagingSenderId: "663485115589",
    appId: "1:663485115589:web:b1c2fa0c96a2664aa88d7d"
  };

  // Inicializa Firebase (modo compat)
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const registrosRef = db.collection("registros_portaria");
  const logEl = document.getElementById("consoleLog");
  const statusEl = document.getElementById("status");
  const form = document.getElementById("formEntrada");

  function log(msg){
    const ts = new Date().toLocaleTimeString();
    logEl.textContent = `[${ts}] ${msg}\n` + logEl.textContent;
    console.log(msg);
  }

  function setStatus(msg, type="secondary"){
    statusEl.className = "alert alert-" + type;
    statusEl.textContent = "Status: " + msg;
  }

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const nome = document.getElementById("nome").value.trim();
    const documento = document.getElementById("documento").value.trim();
    const motivo = document.getElementById("motivo").value.trim();

    if(!nome || !documento){
      setStatus("Preencha nome e documento.", "warning");
      return;
    }

    const dados = {
      nome,
      documento,
      motivo: motivo || null,
      horarioEntrada: new Date().toLocaleString("pt-BR"),
      horarioSaida: null,
      status: "Entrada",
      criadoEm: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      setStatus("Gravando...", "info");
      const ref = await registrosRef.add(dados);
      log("‚úÖ Registro criado com ID: " + ref.id);
      setStatus("Entrada registrada com sucesso!", "success");
      form.reset();
    } catch (err) {
      log("‚ùå Erro ao gravar: " + err.message);
      setStatus("Erro ao gravar: " + err.message, "danger");
    }
  });

  log("Firebase inicializado (modo compat). Pronto para gravar.");
  setStatus("Pronto. Preencha e registre uma entrada.", "secondary");
</script>
</body>
</html>
