<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GateGuard - Controle de Portaria</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    /* Pequeno ajuste para o modal */
    #modal { z-index: 60; }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Navbar -->
  <nav class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">GateGuard</h1>
  </nav>

  <main class="p-8 max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-3xl font-bold text-gray-800">Controle de Portaria</h1>
      <button id="novoRegistroBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
        <i data-feather="plus" class="mr-2"></i> Novo Registro
      </button>
    </div>

    <!-- Filtros -->
    <div class="flex items-center space-x-3 mb-6">
      <span class="text-gray-700 font-semibold">Filtrar:</span>
      <button id="filtroTodos" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">Todos</button>
      <button id="filtroPresentes" class="bg-green-200 hover:bg-green-300 px-3 py-1 rounded">Presentes</button>
      <button id="filtroSaida" class="bg-red-200 hover:bg-red-300 px-3 py-1 rounded">Saíram</button>
    </div>

    <!-- Tabela -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
      <div class="p-6">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200" id="tabelaRegistros">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Visitante</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Documento</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Placa</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Destino</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Motivo</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entrada</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Saída</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
              </tr>
            </thead>
            <tbody id="listaRegistros" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal de novo registro -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-xl w-96">
      <h2 class="text-xl font-semibold mb-4">Novo Registro</h2>
      <input id="visitante" type="text" placeholder="Nome do visitante" class="w-full border p-2 rounded mb-3">
      <input id="documento" type="text" placeholder="Documento (CPF ou RG)" class="w-full border p-2 rounded mb-3">
      <input id="placa" type="text" placeholder="Placa do veículo (ex: ABC1D23)" class="w-full border p-2 rounded mb-3">
      <input id="destino" type="text" placeholder="Destino (Ex: Apto 101)" class="w-full border p-2 rounded mb-3">
      <input id="motivo" type="text" placeholder="Motivo da vinda" class="w-full border p-2 rounded mb-3">
      <div class="flex justify-end space-x-3">
        <button id="cancelar" class="bg-gray-300 px-4 py-2 rounded">Cancelar</button>
        <button id="salvar" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button>
      </div>
    </div>
  </div>

  <footer class="text-center py-4 text-gray-500">© 2025 GateGuard</footer>

  <!-- Script principal: use type=module para Firebase (não mudar) -->
  <script type="module">
    // Espera DOM pronto para evitar problemas com elementos não existentes
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Import Firebase (v10 modular)
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js');
        const { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, serverTimestamp } =
          await import('https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js');

        // ======== CONFIGURE AQUI O FIREBASE ========
        const firebaseConfig = {
          apiKey: "AIzaSyCmZBxRVcmTPJFLdWWcNd07LZPJYZnR5N0",
          authDomain: "portaria-e22ae.firebaseapp.com",
          projectId: "portaria-e22ae",
          storageBucket: "portaria-e22ae.firebasestorage.app",
          messagingSenderId: "663485115589",
          appId: "1:663485115589:web:4b2f860ede7f0f7b5854ac",
          measurementId: "G-QEGQN6CTBB"
        };
        // ===========================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // elementos
        const tabela = document.getElementById("listaRegistros");
        const modal = document.getElementById("modal");
        const btnNovo = document.getElementById("novoRegistroBtn");
        const btnSalvar = document.getElementById("salvar");
        const btnCancelar = document.getElementById("cancelar");

        const filtroTodos = document.getElementById("filtroTodos");
        const filtroPresentes = document.getElementById("filtroPresentes");
        const filtroSaida = document.getElementById("filtroSaida");
        let filtroAtual = "todos";

        // Garanta que os ícones sejam renderizados (icone + texto)
        feather.replace();

        // Abre/fecha modal
        btnNovo.addEventListener("click", () => {
          modal.classList.remove("hidden");
          // foco no primeiro campo
          const v = document.getElementById('visitante');
          if (v) v.focus();
        });
        btnCancelar.addEventListener("click", () => modal.classList.add("hidden"));

        // helper de leitura segura do input
        const inputVal = id => {
          const el = document.getElementById(id);
          return el ? el.value.trim() : "";
        };

        // Salva novo registro
        btnSalvar.addEventListener("click", async () => {
          try {
            const visitante = inputVal("visitante");
            const documento = inputVal("documento");
            const placa = inputVal("placa");
            const destino = inputVal("destino");
            const motivo = inputVal("motivo");

            if (!visitante || !documento || !destino || !motivo) {
              alert("Preencha todos os campos obrigatórios: visitante, documento, destino e motivo.");
              return;
            }

            await addDoc(collection(db, "registros"), {
              visitante,
              documento,
              placa: placa || "-",
              destino,
              motivo,
              entrada: new Date().toLocaleString(),
              saida: "-",
              timestamp: serverTimestamp()
            });

            // limpa campos e fecha modal
            ["visitante","documento","placa","destino","motivo"].forEach(id => {
              const el = document.getElementById(id);
              if (el) el.value = "";
            });
            modal.classList.add("hidden");
          } catch (err) {
            console.error("Erro ao salvar registro:", err);
            alert("Erro ao salvar. Veja o console para detalhes.");
          }
        });

        // Renderização com filtro e listeners
        function renderizar(registros) {
          tabela.innerHTML = "";

          let filtrados = registros;
          if (filtroAtual === "presentes") filtrados = registros.filter(r => r.saida === "-" || !r.saida);
          if (filtroAtual === "saida") filtrados = registros.filter(r => r.saida && r.saida !== "-");

          filtrados.forEach(dados => {
            const tr = document.createElement("tr");
            const temSaida = dados.saida && dados.saida !== "-";

            tr.innerHTML = `
              <td class="px-6 py-4 text-sm text-gray-900">${escapeHtml(dados.visitante)}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.documento)}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.placa || "-")}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.destino)}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.motivo || "-")}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.entrada)}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.saida)}</td>
              <td class="px-6 py-4 text-sm">
                ${!temSaida
                  ? `<button class="text-green-600 hover:text-green-900 mr-3" data-saida="${dados.id}" title="Registrar saída">
                       <i data-feather="log-out"></i>
                     </button>
                     <button class="text-red-600 hover:text-red-900" data-del="${dados.id}" title="Excluir registro">
                       <i data-feather="trash-2"></i>
                     </button>`
                  : `<span class="text-gray-400 italic">Concluído</span>`
                }
              </td>
            `;
            tabela.appendChild(tr);
          });

          // renderiza ícones novamente (novos botões)
          feather.replace();

          // listeners (registrando depois de inserir no DOM)
          document.querySelectorAll("[data-saida]").forEach(btn => {
            btn.addEventListener("click", async (ev) => {
              try {
                const id = btn.dataset.saida;
                if (!id) return;
                if (!confirm("Registrar saída deste visitante?")) return;
                await updateDoc(doc(db, "registros", id), { saida: new Date().toLocaleString() });
                // após update, onSnapshot atualizará a tabela
              } catch (err) {
                console.error("Erro ao registrar saída:", err);
                alert("Erro ao registrar saída. Veja o console.");
              }
            });
          });

          document.querySelectorAll("[data-del]").forEach(btn => {
            btn.addEventListener("click", async () => {
              try {
                const id = btn.dataset.del;
                if (!id) return;
                if (!confirm("Deseja excluir este registro?")) return;
                await deleteDoc(doc(db, "registros", id));
              } catch (err) {
                console.error("Erro ao deletar:", err);
                alert("Erro ao excluir registro. Veja o console.");
              }
            });
          });
        }

        // defesa contra XSS simples na exibição
        function escapeHtml(str) {
          if (!str && str !== 0) return "";
          return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        // Filtros
        filtroTodos.addEventListener("click", () => { filtroAtual = "todos"; atualizarCorFiltros(); });
        filtroPresentes.addEventListener("click", () => { filtroAtual = "presentes"; atualizarCorFiltros(); });
        filtroSaida.addEventListener("click", () => { filtroAtual = "saida"; atualizarCorFiltros(); });

        function atualizarCorFiltros() {
          [filtroTodos, filtroPresentes, filtroSaida].forEach(btn => {
            btn.classList.remove("ring-2","ring-blue-500");
          });
          if (filtroAtual === "todos") filtroTodos.classList.add("ring-2","ring-blue-500");
          if (filtroAtual === "presentes") filtroPresentes.classList.add("ring-2","ring-blue-500");
          if (filtroAtual === "saida") filtroSaida.classList.add("ring-2","ring-blue-500");
        }
        atualizarCorFiltros();

        // onSnapshot em tempo real
        const colRef = collection(db, "registros");
        onSnapshot(colRef, (snapshot) => {
          const docs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
          // ordena por timestamp (mais recente primeiro), se existir
          docs.sort((a,b) => {
            const ta = a.timestamp ? a.timestamp.seconds || 0 : 0;
            const tb = b.timestamp ? b.timestamp.seconds || 0 : 0;
            return tb - ta;
          });
          renderizar(docs);
        }, (err) => {
          console.error("Erro no onSnapshot:", err);
        });

      } catch (err) {
        console.error("Erro no script principal:", err);
        alert("Ocorreu um erro ao carregar funcionalidades. Veja o console (F12).");
      }
    });
  </script>

  <script>
    // Garante que ícones básicos do HTML (antes do module) também sejam renderizados
    try { feather.replace(); } catch (e) { /* ignore */ }
  </script>
</body>
</html>
