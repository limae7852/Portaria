<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Debug - Controle de Portaria (Firestore)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;padding:20px}
    .card{background:#fff;padding:16px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.06);max-width:900px;margin:12px auto}
    input,button{padding:8px;border-radius:6px;border:1px solid #cbd5e1}
    button{cursor:pointer}
    #status{margin-top:10px;padding:8px;border-radius:6px;background:#f8fafc;color:#0f172a}
    .error{background:#fff1f2;color:#991b1b;border:1px solid #fecaca}
    .ok{background:#ecfdf5;color:#064e3b;border:1px solid #bbf7d0}
    .log{font-family:monospace;white-space:pre-wrap;max-height:220px;overflow:auto;padding:8px;background:#0f172a;color:#e6eef8;border-radius:6px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Controle de Portaria — Debug</h2>
    <p>Use este arquivo para testar gravação e ver mensagens de erro diretamente.</p>

    <form id="form" onsubmit="event.preventDefault(); registrarEntrada();">
      <input id="nome" placeholder="Nome do visitante" required style="width:48%;margin-right:4%"/>
      <input id="documento" placeholder="Documento (RG/CPF)" required style="width:48%"/><br/><br/>
      <input id="veiculo" placeholder="Veículo / Placa" style="width:32%;margin-right:2%"/>
      <input id="destino" placeholder="Destino" style="width:32%;margin-right:2%"/>
      <input id="motivo" placeholder="Motivo" style="width:32%"/><br/><br/>
      <button id="btnEntrar" type="submit">Registrar Entrada</button>
      <button id="btnTest" type="button">Testar JS</button>
    </form>

    <div id="status" class="ok">Status: aguardando ação...</div>

    <h4>Console (logs do script)</h4>
    <div id="consoleLog" class="log"></div>
  </div>

  <script type="module">
    // ---------------- IMPORTS FIREBASE ----------------
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "firebase/app";
    import { getAnalytics } from "firebase/analytics";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyCmZBxRVcmTPJFLdWWcNd07LZPJYZnR5N0",
      authDomain: "portaria-e22ae.firebaseapp.com",
      projectId: "portaria-e22ae",
      storageBucket: "portaria-e22ae.firebasestorage.app",
      messagingSenderId: "663485115589",
      appId: "1:663485115589:web:4b2f860ede7f0f7b5854ac",
      measurementId: "G-QEGQN6CTBB"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
  
    // -------------------------------------------------

    // UI helpers
    const statusEl = document.getElementById('status')
    const logEl = document.getElementById('consoleLog')
    const btnEntrar = document.getElementById('btnEntrar')
    const btnTest = document.getElementById('btnTest')

    function log(msg){
      const ts = new Date().toLocaleTimeString()
      logEl.textContent = `[${ts}] ${msg}\n` + logEl.textContent
      console.log(msg)
    }
    function setStatus(msg, type='ok'){
      statusEl.textContent = 'Status: ' + msg
      statusEl.className = type === 'error' ? 'error' : 'ok'
    }

    // quick checks
    if(!firebaseConfig || !firebaseConfig.projectId || firebaseConfig.projectId === 'SEU_PROJETO'){
      setStatus('Erro: firebaseConfig não preenchido ou contém placeholders. Cole seu firebaseConfig.', 'error')
      log('firebaseConfig ausente ou com placeholders. Pare e insira as credenciais reais.')
      // Still continue so user can see JS loaded
    } else {
      log('firebaseConfig detectado: projectId=' + firebaseConfig.projectId)
    }

    let db = null
    try {
      const app = initializeApp(firebaseConfig)
      db = getFirestore(app)
      log('Firebase inicializado com sucesso.')
      setStatus('Firebase inicializado. Pronto para gravação.')
    } catch(err) {
      setStatus('Erro ao inicializar Firebase: ' + (err.message || err), 'error')
      log('Erro inicializando Firebase: ' + err?.message)
      // stop here — registrarEntrada will still try and show useful error
    }

    // function to save entry
    async function registrarEntrada(){
      log('registrarEntrada() chamada.')
      setStatus('Gravando...', 'ok')
      btnEntrar.disabled = true

      const nome = document.getElementById('nome').value.trim()
      const documento = document.getElementById('documento').value.trim()
      const veiculo = document.getElementById('veiculo').value.trim()
      const destino = document.getElementById('destino').value.trim()
      const motivo = document.getElementById('motivo').value.trim()

      if(!nome || !documento){
        setStatus('Erro: nome e documento são obrigatórios.', 'error')
        log('Validação: campos obrigatórios ausentes.')
        btnEntrar.disabled = false
        return
      }

      if(!db){
        setStatus('Erro: Firestore não inicializado corretamente. Verifique firebaseConfig e console.', 'error')
        log('Abortando gravação: db é null.')
        btnEntrar.disabled = false
        return
      }

      try{
        // mostra o payload nos logs antes de gravar
        const payload = { nome, documento, veiculo: veiculo||null, destino: destino||null, motivo: motivo||null, horarioEntrada: serverTimestamp(), horarioSaida: null, status: 'Entrada' }
        log('Payload a ser gravado: ' + JSON.stringify({ nome, documento, veiculo, destino, motivo }))
        const ref = await addDoc(collection(db, 'registros_portaria'), payload)
        log('Documento salvo com id: ' + ref.id)
        setStatus('✅ Gravado com sucesso (id: ' + ref.id + ')')
        // limpar campos
        document.getElementById('form').reset()
      } catch (err) {
        // erros comuns: permissões, invalid-api-key, network
        const em = err?.message || String(err)
        log('Erro ao gravar: ' + em)
        setStatus('Erro ao gravar: ' + em, 'error')
      } finally {
        btnEntrar.disabled = false
      }
    }

    // expose for inline form attribute
    window.registrarEntrada = registrarEntrada

    // test button: verifica se a função está ligada
    btnTest.addEventListener('click', () => {
      log('Botão Testar JS clicado — verificação básica.')
      setStatus('Teste: JS carregado e respondendo.')
    })

    // também captura erros globais para mostrar no painel
    window.addEventListener('error', (e) => {
      log('Erro global detectado: ' + (e.error?.message || e.message || e))
      setStatus('Erro runtime: ' + (e.error?.message || e.message || e), 'error')
    })

    window.addEventListener('unhandledrejection', (ev) => {
      log('UnhandledRejection: ' + (ev.reason?.message || ev.reason || JSON.stringify(ev.reason)))
      setStatus('Erro promise: ' + (ev.reason?.message || ev.reason || ''), 'error')
    })
  </script>
</body>
</html>
