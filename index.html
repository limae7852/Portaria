<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GateGuard - Controle de Portaria</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    #modal { z-index: 60; }
    .filter-active { box-shadow: 0 0 0 3px rgba(59,130,246,0.25); }
  </style>
</head>
<body class="bg-gray-50">
  <nav class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">GateGuard</h1>
  </nav>

  <main class="p-8 max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-3xl font-bold text-gray-800">Controle de Portaria</h1>
      <button id="novoRegistroBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
        <i data-feather="plus" class="mr-2"></i> Novo Registro
      </button>
    </div>

    <!-- Filtros -->
    <div class="flex items-center space-x-3 mb-6">
      <span class="text-gray-700 font-semibold">Filtrar:</span>
      <button id="filtroTodos" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">Todos</button>
      <button id="filtroPresentes" class="bg-green-200 hover:bg-green-300 px-3 py-1 rounded">Presentes</button>
      <button id="filtroSaida" class="bg-red-200 hover:bg-red-300 px-3 py-1 rounded">Saíram</button>
    </div>

    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
      <div class="p-6">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200" id="tabelaRegistros">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Visitante</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Documento</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Placa</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Destino</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Motivo</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entrada</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Saída</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
              </tr>
            </thead>
            <tbody id="listaRegistros" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal de novo registro -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-xl w-96">
      <h2 class="text-xl font-semibold mb-4">Novo Registro</h2>
      <input id="visitante" type="text" placeholder="Nome do visitante" class="w-full border p-2 rounded mb-3">
      <input id="documento" type="text" placeholder="Documento (CPF ou RG)" class="w-full border p-2 rounded mb-3">
      <input id="placa" type="text" placeholder="Placa do veículo (ex: ABC1D23)" class="w-full border p-2 rounded mb-3">
      <input id="destino" type="text" placeholder="Destino (Ex: Apto 101)" class="w-full border p-2 rounded mb-3">
      <input id="motivo" type="text" placeholder="Motivo da vinda" class="w-full border p-2 rounded mb-3">
      <div class="flex justify-end space-x-3">
        <button id="cancelar" class="bg-gray-300 px-4 py-2 rounded">Cancelar</button>
        <button id="salvar" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button>
      </div>
    </div>
  </div>

  <footer class="text-center py-4 text-gray-500">© 2025 GateGuard</footer>

  <script type="module">
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js');
        const {
          getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, serverTimestamp
        } = await import('https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js');

        // ====== CONFIGURE AQUI ======
        const firebaseConfig = {
          apiKey: "AIzaSyCmZBxRVcmTPJFLdWWcNd07LZPJYZnR5N0",
          authDomain: "portaria-e22ae.firebaseapp.com",
          projectId: "portaria-e22ae",
          storageBucket: "portaria-e22ae.firebasestorage.app",
          messagingSenderId: "663485115589",
          appId: "1:663485115589:web:4b2f860ede7f0f7b5854ac",
          measurementId: "G-QEGQN6CTBB"
        };
        // ============================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // elementos
        const tabela = document.getElementById("listaRegistros");
        const modal = document.getElementById("modal");
        const btnNovo = document.getElementById("novoRegistroBtn");
        const btnSalvar = document.getElementById("salvar");
        const btnCancelar = document.getElementById("cancelar");

        const filtroTodos = document.getElementById("filtroTodos");
        const filtroPresentes = document.getElementById("filtroPresentes");
        const filtroSaida = document.getElementById("filtroSaida");

        let filtroAtual = "todos";
        let docsCache = []; // <-- cache local dos dados

        // Render inicial de icons
        try { feather.replace(); } catch(e) {}

        // abrir/fechar modal
        btnNovo.addEventListener("click", () => {
          modal.classList.remove("hidden");
          const v = document.getElementById('visitante');
          if (v) v.focus();
        });
        btnCancelar.addEventListener("click", () => modal.classList.add("hidden"));

        const getVal = id => (document.getElementById(id) ? document.getElementById(id).value.trim() : "");

        // salvar
        btnSalvar.addEventListener("click", async () => {
          try {
            const visitante = getVal("visitante");
            const documento = getVal("documento");
            const placa = getVal("placa");
            const destino = getVal("destino");
            const motivo = getVal("motivo");

            if (!visitante || !documento || !destino || !motivo) {
              alert("Preencha os campos obrigatórios: visitante, documento, destino e motivo.");
              return;
            }

            await addDoc(collection(db, "registros"), {
              visitante,
              documento,
              placa: placa || "-",
              destino,
              motivo,
              entrada: new Date().toLocaleString(),
              saida: "-",
              timestamp: serverTimestamp()
            });

            ["visitante","documento","placa","destino","motivo"].forEach(id => {
              const el = document.getElementById(id); if (el) el.value = "";
            });
            modal.classList.add("hidden");
          } catch (err) {
            console.error("Erro salvar:", err); alert("Erro ao salvar (veja console).");
          }
        });

        // renderiza tabela com base em registros passados
        function renderizar(registros) {
          tabela.innerHTML = "";
          let filtrados = registros;
          if (filtroAtual === "presentes") filtrados = registros.filter(r => !r.saida || r.saida === "-");
          if (filtroAtual === "saida") filtrados = registros.filter(r => r.saida && r.saida !== "-");

          // se nenhum registro
          if (filtrados.length === 0) {
            tabela.innerHTML = `<tr><td class="px-6 py-8 text-center text-gray-500" colspan="8">Nenhum registro encontrado.</td></tr>`;
            return;
          }

          filtrados.forEach(dados => {
            const temSaida = dados.saida && dados.saida !== "-";
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="px-6 py-4 text-sm text-gray-900">${escapeHtml(dados.visitante)}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.documento)}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.placa || "-")}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.destino)}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.motivo || "-")}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.entrada)}</td>
              <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(dados.saida)}</td>
              <td class="px-6 py-4 text-sm">
                ${!temSaida
                  ? `<button class="text-green-600 hover:text-green-900 mr-3" data-saida="${dados.id}" title="Registrar saída"><i data-feather="log-out"></i></button>
                     <button class="text-red-600 hover:text-red-900" data-del="${dados.id}" title="Excluir registro"><i data-feather="trash-2"></i></button>`
                  : `<span class="text-gray-400 italic">Concluído</span>`
                }
              </td>
            `;
            tabela.appendChild(tr);
          });

          feather.replace();

          // listeners dos botões inseridos
          document.querySelectorAll("[data-saida]").forEach(btn => {
            btn.addEventListener("click", async () => {
              const id = btn.dataset.saida;
              if (!id) return;
              if (!confirm("Registrar saída deste visitante?")) return;
              try {
                await updateDoc(doc(db, "registros", id), { saida: new Date().toLocaleString() });
                // onSnapshot atualizará docsCache e re-renderizará
              } catch (err) { console.error("Erro saída:", err); alert("Erro ao registrar saída."); }
            });
          });

          document.querySelectorAll("[data-del]").forEach(btn => {
            btn.addEventListener("click", async () => {
              const id = btn.dataset.del;
              if (!id) return;
              if (!confirm("Deseja excluir este registro?")) return;
              try {
                await deleteDoc(doc(db, "registros", id));
              } catch (err) { console.error("Erro deletar:", err); alert("Erro ao excluir registro."); }
            });
          });
        }

        function escapeHtml(str) {
          if (str === null || str === undefined) return "";
          return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
                            .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
        }

        // filtros: alteram filtroAtual, atualizam visual e re-renderizam imediatamente usando docsCache
        function setFilter(f) {
          filtroAtual = f;
          atualizarVisualFiltro();
          renderizar(docsCache);
        }
        filtroTodos.addEventListener("click", () => setFilter("todos"));
        filtroPresentes.addEventListener("click", () => setFilter("presentes"));
        filtroSaida.addEventListener("click", () => setFilter("saida"));

        function atualizarVisualFiltro() {
          [filtroTodos, filtroPresentes, filtroSaida].forEach(btn => btn.classList.remove("filter-active"));
          if (filtroAtual === "todos") filtroTodos.classList.add("filter-active");
          if (filtroAtual === "presentes") filtroPresentes.classList.add("filter-active");
          if (filtroAtual === "saida") filtroSaida.classList.add("filter-active");
        }
        atualizarVisualFiltro();

        // onSnapshot atualiza docsCache e re-renderiza com o filtro atual
        const colRef = collection(db, "registros");
        onSnapshot(colRef, (snapshot) => {
          docsCache = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
          // opcional: ordenar por timestamp (mais recente primeiro)
          docsCache.sort((a,b) => {
            const ta = a.timestamp ? (a.timestamp.seconds || 0) : 0;
            const tb = b.timestamp ? (b.timestamp.seconds || 0) : 0;
            return tb - ta;
          });
          renderizar(docsCache);
        }, err => {
          console.error("onSnapshot erro:", err);
        });

      } catch (err) {
        console.error("Erro inicialização:", err);
        alert("Erro ao carregar app. Veja o console (F12).");
      }
    });
  </script>

  <!-- fallback feather init -->
  <script> try { feather.replace(); } catch(e){} </script>
</body>
</html>
