<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Portaria</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f3f4f6;
      margin: 40px;
    }
    h2 {
      text-align: center;
      color: #222;
    }
    form {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 6px #ccc;
      margin-bottom: 20px;
      max-width: 600px;
      margin-inline: auto;
    }
    input, button {
      padding: 8px;
      margin: 6px 0;
      width: 100%;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #007bff;
      color: white;
    }
  </style>

  <script type="module">
    // ---------------- FIREBASE IMPORTS ----------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
   
    // ---------------- CONFIGURAÃ‡ÃƒO DO SEU PROJETO ----------------
    const firebaseConfig = {
      apiKey: "AIzaSyCmZBxRVcmTPJFLdWWcNd07LZPJYZnR5N0",
      authDomain: "portaria-e22ae.firebaseapp.com",
      projectId: "portaria-e22ae",
      storageBucket: "portaria-e22ae.firebasestorage.app",
      messagingSenderId: "663485115589",
      appId: "1:663485115589:web:4b2f860ede7f0f7b5854ac",
      measurementId: "G-QEGQN6CTBB"
    };

    // ---------------- INICIALIZA O FIREBASE ----------------
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------------- REGISTRAR ENTRADA ----------------
    async function registrarEntrada() {
      const nome = document.getElementById('nome').value.trim();
      const documento = document.getElementById('documento').value.trim();
      const veiculo = document.getElementById('veiculo').value.trim();
      const destino = document.getElementById('destino').value.trim();
      const motivo = document.getElementById('motivo').value.trim();

      if (!nome || !documento) {
        alert("Preencha pelo menos o nome e o documento!");
        return;
      }

      try {
        await addDoc(collection(db, "registros_portaria"), {
          nome,
          documento,
          veiculo,
          destino,
          motivo,
          horarioEntrada: serverTimestamp(),
          horarioSaida: null,
          status: "Entrada"
        });
        alert("âœ… Entrada registrada com sucesso!");
        limparCampos();
        carregarHistorico();
      } catch (error) {
        alert("âŒ Erro ao salvar: " + error.message);
        console.error(error);
      }
    }

    // ---------------- REGISTRAR SAÃDA ----------------
    async function registrarSaida(id) {
      try {
        const registroRef = doc(db, "registros_portaria", id);
        await updateDoc(registroRef, {
          horarioSaida: serverTimestamp(),
          status: "SaÃ­da"
        });
        alert("ðŸšª SaÃ­da registrada com sucesso!");
        carregarHistorico();
      } catch (error) {
        alert("âŒ Erro ao registrar saÃ­da: " + error.message);
        console.error(error);
      }
    }

    // ---------------- CARREGAR HISTÃ“RICO ----------------
    async function carregarHistorico() {
      const tabela = document.getElementById("tabelaHistorico");
      tabela.innerHTML = "";

      try {
        const querySnapshot = await getDocs(collection(db, "registros_portaria"));
        querySnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const linha = document.createElement("tr");

          linha.innerHTML = `
            <td>${data.nome || "-"}</td>
            <td>${data.documento || "-"}</td>
            <td>${data.veiculo || "-"}</td>
            <td>${data.destino || "-"}</td>
            <td>${data.motivo || "-"}</td>
            <td>${data.status || "-"}</td>
            <td>${data.horarioEntrada ? new Date(data.horarioEntrada.seconds * 1000).toLocaleString() : "-"}</td>
            <td>${data.horarioSaida ? new Date(data.horarioSaida.seconds * 1000).toLocaleString() : "-"}</td>
            <td>
              ${data.status === "Entrada"
                ? `<button onclick="registrarSaida('${docSnap.id}')">Registrar SaÃ­da</button>`
                : "-"}
            </td>
          `;

          tabela.appendChild(linha);
        });
      } catch (error) {
        console.error("Erro ao carregar histÃ³rico:", error);
      }
    }

    function limparCampos() {
      document.querySelectorAll("input").forEach(i => i.value = "");
    }

    // ---------------- INICIALIZA ----------------
    window.onload = carregarHistorico;
    window.registrarEntrada = registrarEntrada;
    window.registrarSaida = registrarSaida;
  </script>
</head>

<body>
  <h2>ðŸ“‹ Sistema de Controle de Portaria</h2>

  <form onsubmit="event.preventDefault(); registrarEntrada();">
    <input id="nome" placeholder="Nome do Visitante" required />
    <input id="documento" placeholder="Documento (RG/CPF)" required />
    <input id="veiculo" placeholder="VeÃ­culo / Placa" />
    <input id="destino" placeholder="Destino / Setor" />
    <input id="motivo" placeholder="Motivo da Visita" />
    <button type="submit">Registrar Entrada</button>
  </form>

  <h3>ðŸ“œ HistÃ³rico de Entradas e SaÃ­das</h3>
  <table>
    <thead>
      <tr>
        <th>Nome</th>
        <th>Documento</th>
        <th>VeÃ­culo</th>
        <th>Destino</th>
        <th>Motivo</th>
        <th>Status</th>
        <th>Entrada</th>
        <th>SaÃ­da</th>
        <th>AÃ§Ã£o</th>
      </tr>
    </thead>
    <tbody id="tabelaHistorico"></tbody>
  </table>
</body>
</html>
